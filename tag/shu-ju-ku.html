<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <!-- Set the viewport width to device width for mobile -->
    <meta name="viewport" content="width=device-width" />

    <title>仗梦天涯&nbsp;&nbsp;&nbsp;&nbsp;倚霞而栖 - 数据库</title>

    <link rel="stylesheet" href="/theme/css/normalize.css" />
    <link rel="stylesheet" href="/theme/css/foundation.min.css" />
    <link rel="stylesheet" href="/theme/css/style.css" />
    <link rel="stylesheet" href="/theme/css/pygments.css" />	
    <script src="/theme/js/modernizr.js"></script>
</head>

<body>

<!-- Nav Bar -->
<nav>
<div class="top-bar">
<div class="row">
    <div class="large-9 large-centered columns">
	    <h1><a href="">仗梦天涯&nbsp;&nbsp;&nbsp;&nbsp;倚霞而栖</a></h1>
    </div>
</div>
</div>

<!-- Show menu items and pages -->
<div class="row">
<div class="large-9 columns">
    <ul class="button-group navigation">
    <li><a href="tags.html" class="button secondary small">Tags</a></li>
    <li><a href="about.html" class="button secondary small">About</a></li>

    </ul>
</div>
</div>
</nav>
<!-- End Nav -->


<!-- Main Page Content and Sidebar -->
<div class="row">

    <!-- Main Blog Content -->
    <div class="large-9 columns">
        
        

            <article>
                <a href="/play-databases.html"><h3 class="article-title">主流数据库安装、维护、开发与管理</h3></a>
<h6 class="subheader" title="2015-12-22T17:28:50+08:00">Tue 22 December 2015
</h6>


<p>记录数据库 安装、维护、开发与管理 的各种操作&amp;技巧。包含但不仅限于db2,oracle , mysql , sqlite...</p>

<h1 id="db2">DB2</h1>
<h2 id="response-db2-ese-v97">使用response文件安装 db2 ese v9.7</h2>
<p>Response file installation of DB2 overview (Linux and UNIX)
This task describes how to perform response file installations on Linux or UNIX. You can use the response file to install additional components or products after an initial installation. A response file installation might also be referred to as a silent installation or an unattended installation.</p>
<p>About this task
Restrictions</p>
<p>Be aware of the following limitations when using the response files method to install DB2 on Linux or UNIX operating systems:
If you set any instance or global profile registry keywords to BLANK (the word "BLANK"), that keyword is, in effect, deleted from the list of currently set keywords.
Ensure that you have sufficient disk space before installing. Otherwise, if the installation fails, manual cleanup is required.
If you are performing multiple installations or are installing DB2 database products from multiple DVDs, it is recommended that you install from a network file system rather than a DVD drive. Installing from a network file system significantly decreases the amount of time it will take to perform the installation.
If you are planning on installing multiple clients, set up a mounted file system on a code server to improve performance.
Before you begin
Before you begin the installation, ensure that:
Your system meets all of the memory, hardware, and software requirements to install your DB2® database product.
All DB2 processes are stopped. If you are installing a DB2 database product on top of an existing DB2 installation on the computer, you must stop all DB2 applications, the DB2 database manager, and DB2 processes for all DB2 instances and DB2 DAS related to the existing DB2 installation.
Procedure
To perform a response file installation:</p>
<p>Mount your DB2 database product DVD or access the file system where the installation image is stored.
Create a response file using the sample response file. Refer to Creating a response file using the sample response file (Linux and UNIX).
Response files have a file type of .rsp. For example, ese.rsp.</p>
<p>Install DB2 using the response file. Refer to Installing a DB2 database product using a response file (Linux and UNIX).
Creating a response file using the sample response file (Linux and UNIX)
Installing a DB2 database product using a response file (Linux and UNIX)
Installing database partition servers on participating computers using a response file (Linux and UNIX)
In this task you will use the response file you created using the DB2 Setup wizard to install database partition servers on participating computers.
Response file error codes (Linux and UNIX)
Uninstalling a DB2 database product, feature, or language using a response file (Linux and UNIX)
To silently uninstall DB2 database products, features, or languages in a DB2 copy, use the db2_deinstall command with the -r option.</p>
<p>ref: https://www-01.ibm.com/support/knowledgecenter/#!/SSEPGG_9.7.0/com.ibm.db2.luw.qb.server.doc/doc/t0007298.html
ref: http://db2commerce.com/2012/06/25/installing-db2-using-a-response-file/</p>
<h2 id="db2-ese">db2 ese 安装相关的几个问题</h2>
<ol>
<li>如何使用响应文件安装 db2 ese ?</li>
</ol>
<p>db2setup -r /path/to/response_file</p>
<ol>
<li>response 文件模版哪里有？</li>
</ol>
<p>安装包目录中有模版。</p>
<ol>
<li>ese 如何 添加 license ?</li>
</ol>
<p>db2licm -a /path/to/license ?</p>
<ol>
<li>一台机器是否可以按装多套不同版本的db2 产品？</li>
</ol>
<p>可以。使用 db2ls 查看各个安装版本的安装情况。</p>
<p>同时：同一个版本，可以创建多个instance，一个instance可以创建多个数据库。</p>
<ol>
<li>db2 安装前，要创建用户和组，为什么？ </li>
</ol>
<p>https://bytes.com/topic/db2/answers/181692-what-db2-users-db2fenc1-dasusr1</p>
<p>说说我自己的理解：</p>
<ol>
<li>
<p>权限隔离－－什么的功能，就用什么样的用户来管理。隔离了权限，不至于混乱。否则一个文件谁都可以改，就乱套了。</p>
</li>
<li>
<p>安全考虑。 其实 1 也就是安全考虑。</p>
</li>
</ol>
<p>http://www-01.ibm.com/support/knowledgecenter/?lang=en#!/SSEPGG_9.7.0/com.ibm.db2.luw.qb.server.doc/doc/c0011931.html</p>
<p>http://www.ibm.com/developerworks/data/library/techarticle/dm-0508wasserman/</p>
<p>https://www-01.ibm.com/support/knowledgecenter/#!/SSEPGG_9.5.0/com.ibm.db2.luw.admin.sec.doc/doc/c0005375.html</p>
<ol>
<li>如何创建的问题：</li>
</ol>
<p>https://www-304.ibm.com/support/knowledgecenter/#!/SSEPGG_10.5.0/com.ibm.db2.luw.qb.server.doc/doc/t0007016.html</p>
<ol>
<li>
<p>强制重建 sample数据库：</p>
<p>db2sampl  -force -sql -verbose -name testdb</p>
</li>
</ol>
<h2 id="_1">分页大小测试</h2>
<h3 id="8k-pagesize">8k PAGESIZE 分页测试：</h3>
<p>create table testvarchar( c1 varchar(30000) ,c2 varchar(2000) ,c3 varchar(662) ) 
DB20000I  The SQL command completed successfully.</p>
<p>32662 is ok  !
32663 is not ok !</p>
<p>SQL0670N  The row length of the table exceeded a limit of "32677" bytes. </p>
<p>说明，还有一些字节被其他东西占用了。</p>
<p>create table testvarchar( c1 varchar(30000) ,c2 varchar(2000) ,c3 varchar(660) ) in testtbs01
DB21034E  The command was processed as an SQL statement because it was not a 
valid Command Line Processor command.  During SQL processing it returned:
SQL0670N  The row length of the table exceeded a limit of "4005" bytes. (Table 
space "TESTTBS01".)  SQLSTATE=54010</p>
<h3 id="4k-pagesize">4K pagesize 分页测试：</h3>
<p>CREATE BUFFERPOOL testbpool  SIZE 2000 PAGESIZE 4K ;</p>
<p>CREATE TABLESPACE testtbs01 PAGESIZE 4K MANAGED BY DATABASE USING (FILE '/tmp/UMPSYS01.dms' 10M)  BUFFERPOOL testbpool;</p>
<p>drop table testvarchar;</p>
<p>create table testvarchar(
     c1 varchar(4000)
     ) in testtbs01;</p>
<pre><code> 可见，

 1.根据表空间分页大小的不同，对于行的存储大小也不同。这直接导致了varchar(n) 中 n 的大小限制。

 2.所谓分页，其实就是表中每条纪录的总长度限制。不管字段多少，算的是总和。

 3. sql messages 中提示的 limit 值，其实是偏大的。比如 4k的表空间 ，提示 limit ＝ 4005 ， 其实你只能 对varchar(n )  指定最大的n值为
 varchar(4000)  , varchar(4001) 都会报错。
</code></pre>
<h2 id="db2db2etldbadm-schema">在db2上授权一个用户db2etl，让这个用户具备dbadm &amp; schema创建权限。</h2>
<p>2015-12-15 Tue 20:57 PM</p>
<p>--db2 列出schema下所有的tables</p>
<p>db2 list tables for schema syscat | grep -i auth</p>
<p>user@localhost:~$ db2 list tables for schema metadata</p>
<p>-- 指定当前schema 
set current schema = 'KALIE'</p>
<p>--database 已经默认为当前connect 的用户, 例如sample :</p>
<p>GRANT DBADM ON DATABASE to db2admin  --- 是不行的，必须声明是 user , e.g:</p>
<p>[db2inst1@localhost ~]$ db2 grant dbadm on database to db2etl</p>
<p>DB21034E  The command was processed as an SQL statement because it was not a 
valid Command Line Processor command.  During SQL processing it returned:
SQL0569N  Authorization ID "DB2ETL" does not uniquely identify a user, a group 
or a role in the system.  SQLSTATE=56092</p>
<p>--解释：</p>
<p>SEPGG_9.5.0/com.ibm.db2.luw.messages.sql.doc/doc/msql00569n.html</p>
<p>SQL0569N
Authorization ID authorization-name does not uniquely identify a user, a group or a role in the system.</p>
<p>Explanation</p>
<p>The authorization ID specified by the GRANT or REVOKE statement does not uniquely identify a user, a role, or a group in the security namespace. The reference to authorization-name is ambiguous. Note that when using DCE security, the USER, GROUP or ROLE keyword is always required.</p>
<p>User response</p>
<p>Change the statement to explicitly specify the USER, GROUP or ROLE keyword to uniquely identify the specified authorization id.</p>
<p>ref: http://www-01.ibm.com/support/knowledgecenter/#!/S</p>
<p>--正确的姿势：使用db2inst1 ：</p>
<p>[db2inst1@localhost ~]$ db2 grant dbadm on database to user db2etl</p>
<p>DB20000I  The SQL command completed successfully.</p>
<p>--具备dbadm权限的用户，就具备了创建 db2 schema 的权限：</p>
<p>user@localhost:~$ db2 create schema skm1 AUTHORIZATION db2etl</p>
<p>DB20000I  The SQL command completed successfully.</p>
<p>---查看某schema 下的表名：</p>
<p>user@localhost:~$ db2 "select TABSCHEMA,tabname from syscat.tables where tabschema = 'METADATA'"</p>
<p>set current schema = 'METADATA'</p>
<p>--db2look 是本地客户端的命令，如果客户端版本和服务器有差别，db2look 可能用不了哦：</p>
<p>db2look -d sample -e -l -x  -z metadata -i db2etl -w db2etlpassword</p>
<p>--注意事项：</p>
<p>CREATE TABLE "METADATA"."tmplst"  (
          "TO_inst_id" VARCHAR(64) , 
          "nLevel" INTEGER , 
          "sCort" VARCHAR(8000) ) <br/>
         IN "IBMDB2SAMPLEREL" ; </p>
<pre><code>     这种建表语句是很坑人的，因为大小写混在一起了。请全部用大写。
</code></pre>
<p>如下：</p>
<p>CREATE TABLE "METADATA"."TMPLST"  (
          "TO_INST_ID" VARCHAR(64) , 
          "NLEVEL" INTEGER , 
          "SCORT" VARCHAR(8000) ) <br/>
         IN "IBMDB2SAMPLEREL" </p>
<p>--- 现在 db2etl 已经具备了创建schema的权限&amp;建表权限。所以可以直接用db2etl来管理schema及其下的tables权限分配。</p>
<p>user@localhost:~/sunline$ db2 -tvf db2.sql 
CREATE TABLE "METADATA"."TMPLST"  ( "TO_INST_ID" VARCHAR(64) , "NLEVEL" INTEGER , "SCORT" VARCHAR(8000) ) IN "IBMDB2SAMPLEREL" 
DB20000I  The SQL command completed successfully.</p>
<p>user@localhost:~/sunline$ db2 grant select on METADATA.TMPLST to public
DB20000I  The SQL command completed successfully.</p>
<p>以上，除了给db2etl赋 dbadm 权限用到db2inst1，其他操作都不需要。 只需要用db2etl即可。</p>
<h2 id="_2">启动&amp;连接&amp;测试</h2>
<p>su - db2inst1</p>
<p>db2stop</p>
<p>db2start</p>
<p>db2 connect to sample</p>
<h2 id="_3">密码带特殊字符时，如果连接</h2>
<p>db2 'connect to sample user db2etl using "db2etl!QAZ"'</p>
<p>使用'' 包住connect 语句</p>
<p>使用 "" 包住 密码串。</p>
<p>但是！ 这种方法由于有' ' 的出现，导致变量不能被解释！这样的话，在shell中调用db2 就会遇到一些麻烦了！</p>
<h2 id="sql3001c-an-io-error">SQL3001C  An I/O error</h2>
<p>SQL3001C  An I/O error (reason = "sqlofopn -2079391743") occurred while  opening the output file.
报这个错的原因是路径不存在或路径没有写入权限。</p>
<h2 id="_4">统计表大小，用户空间大小</h2>
<p>从 SYSIBMADM.ADMINTABINFO  统计。</p>
<h2 id="catalog">如何catalog 一个远程数据库</h2>
<pre><code>Wills-MacBook-Pro:bin db2inst1$ db2 UNCATALOG DATABASE sample
DB20000I  The UNCATALOG DATABASE command completed successfully.
DB21056W  Directory changes may not be effective until the directory cache is 
refreshed.
Wills-MacBook-Pro:bin db2inst1$ db2 UNCATALOG node devnode   
DB20000I  The UNCATALOG NODE command completed successfully.
DB21056W  Directory changes may not be effective until the directory cache is 
refreshed.
Wills-MacBook-Pro:bin db2inst1$ db2 catalog tcpip node devnode remote 120.xx.xx.xx server 50000
DB20000I  The CATALOG TCPIP NODE command completed successfully.
DB21056W  Directory changes may not be effective until the directory cache is 
refreshed.
Wills-MacBook-Pro:bin db2inst1$ db2 catalog database sample at node devnode
DB20000I  The CATALOG DATABASE command completed successfully.
DB21056W  Directory changes may not be effective until the directory cache is 
refreshed.
Wills-MacBook-Pro:bin db2inst1$ db2 terminate
DB20000I  The TERMINATE command completed successfully.
Wills-MacBook-Pro:bin db2inst1$ db2 connect to sample
SQL30082N  Security processing failed with reason "3" ("PASSWORD MISSING").  
SQLSTATE=08001
Wills-MacBook-Pro:bin db2inst1$ db2 connect to sample user db2inst1       
Enter current password for db2inst1:

   Database Connection Information

 Database server        = DB2/LINUXX8664 9.7.0
 SQL authorization ID   = DB2INST1
 Local database alias   = SAMPLE

Wills-MacBook-Pro:bin db2inst1$ pwd
/Users/db2inst1/sqllib/bin
Wills-MacBook-Pro:bin db2inst1$ db2 "select count(0) from syscat.tables"

1          
-----------
        426

  1 record(s) selected.
</code></pre>
<h2 id="db2-on-mac">DB2 on mac 很难找！</h2>
<p>我找mac版的艰辛过程：
本来我打算在mac上安装一个client版的就行了，然后远程到云服务器上。google了半天，发现了一个v9.5版本的，但我的mac是10.10 ， 报错，不支持。</p>
<pre><code>DBI1189E There has been an attempt to use db2setup 
on an image for a platform that does not match the current platform 
'Darwin [x86_64]' on which it is being run.

Explanation:

Possible causes include:

- This DB2 install image is not valid for the current 
platform.

- The current platform is not supported by DB2.


User Response:

Install DB2 using the DB2 install image that corresponds 
with the current platform 'Darwin [x86_64]'.
</code></pre>
<p>没办法，只能装个最新的完整版的：</p>
<p>根据这个链接：</p>
<pre><code>https://www-01.ibm.com/marketing/iwm/iwm/web/pick.do?source=swg-db2expressc&amp;S_PKG=dlmacosx&amp;S_TACT=100KG31W&amp;lang=en_US
</code></pre>
<p>进入，注册，然后按要求填写，就可以得到一个下载地址。</p>
<p>还没安装，晚点再写安装&amp;使用体验。</p>
<h2 id="db2-schema">db2 一个系统用户管理多个schema  .</h2>
<p>-- 使用 db2inst1 操作</p>
<pre><code>db2 =&gt; create schema skma AUTHORIZATION  db2etl

DB20000I  The SQL command completed successfully.


db2 =&gt; select * from  skma.testskma

0 record(s) selected.
</code></pre>
<p>db2 =&gt; create table  skma.testskma(id integer)</p>
<p>DB20000I  The SQL command completed successfully.</p>
<p>--使用 db2etl 操作</p>
<pre><code>db2 =&gt; select * from skma.testskma;

SQL0551N  "DB2ETL" does not have the required authorization or privilege to perform operation "EXECUTE" on object "NULLID.SQLC2J23".  SQLSTATE=42501
</code></pre>
<p>解决：</p>
<pre><code>Resolving the problem:
The NULLID.SQLC2H21 package is created by db2clpcs.bnd, which is only in DB2 v9.7. The SQL0551N error may be seen if you have not ran any bind commands from a v9.7 client to the v9.1 or v9.5 database server.
</code></pre>
<p>参考：</p>
<pre><code>http://www-01.ibm.com/support/docview.wss?uid=swg21440573
</code></pre>
<p>-- 使用db2inst1 操作</p>
<pre><code>db2 =&gt; grant execute on package NULLID.SQLC2J23 to public

DB20000I  The SQL command completed successfully.
</code></pre>
<p>--使用db2etl 登陆：</p>
<pre><code>db2 =&gt; select * from  skma.testskma

0 record(s) selected.
</code></pre>
<h2 id="db2-grant-schema">DB2 grant 无法针对 schema 授权</h2>
<p>如果要对某个schema 下的所有表 做批量授权，需要 做批处理。因为db2没有可以直接对schema授权的方法。</p>
<p>具体方法如下：</p>
<pre><code>db2 -tnx "select distinct 'GRANT ALL ON TABLE '||
    '\"'||rtrim(tabschema)||'\".\"'||rtrim(tabname)||'\" TO USER winuser1;'
    from syscat.tables
    where tabschema = 'myschema' "  &gt;&gt; grants.sql

db2 -tvf grants.sql
</code></pre>
<h3 id="_5">更灵活的操作：</h3>
<pre><code>ksh grant_privs.ksh DB_X USER_X SCHEMA_X insert,delete,update,select
</code></pre>
<p>脚本如下：</p>
<pre><code>#!/bin/ksh
# Grant privileges for a user or group on a specified schema
#---------------------------------------------------------------------------------------------

. ~/sqllib/db2profile

NUMARGS=$#

if [[ $NUMARGS -ne "4" ]]; then
        echo "Usage: $0 database userid schema privilege,..."
        echo "SYSADM authority required."
        exit -2
fi

typeset -u SCHEMA=$3
$(db2 connect to $1)
STMT="db2 select tabname from syscat.tables where tabschema='$SCHEMA'"
TABLES_TO_GRANT=$($STMT|egrep -v "TABNAME|----|selected.")
for TAB in $TABLES_TO_GRANT; do
     cmd="db2 grant $4 on $3.$TAB to $2"
     echo $cmd
     ret=$($cmd)
     echo $ret
done
</code></pre>
<p>Grant privileges for a user or group on a specified schema</p>
<pre><code>http://www.dbatodba.com/db2/scripts-db2/shell-scripts-to-db2/grant-privileges-for-a-user-or-group-on-a-specified-schema/
</code></pre>
<h2 id="db2_1">DB2 建表注意事项</h2>
<ol>
<li>
<p>尽量用大写</p>
</li>
<li>
<p>尽量不用双引号</p>
</li>
</ol>
<p>CREATE TABLE "METADATA"."tmplst"  ( "TO_inst_id" VARCHAR(64) , "nLevel" INTEGER , "sCort" VARCHAR(8000) )   IN "IBMDB2SAMPLEREL" 
CREATE TABLE METADATA.tmplst  ( TO_inst_id VARCHAR(64) , nLevel INTEGER , sCort VARCHAR(8000) )   IN IBMDB2SAMPLEREL 
大小写只是习惯问题。但是如果加了双引号，性质就变了。</p>
<ol>
<li>
<p>大写＋双引号 建的表，小写不带双引号,大写带双引号，大写不带双引号都可以访问。</p>
</li>
<li>
<p>小写＋双引号 建的表  就只有小写＋双引号才能访问了。</p>
</li>
</ol>
<h2 id="db2-timestamp">DB2 如何对日期timestamp设置默认值</h2>
<pre><code>drop table tt;

create table tt (
    begin_dt timestamp not null default current timestamp
        , end_dt timestamp not null default '2000-01-01 00:00:00'
        );
</code></pre>
<ol>
<li>
<p>default 后面跟的日期必须是真实存在的日期。不能是0000-00-00... 之类的。</p>
</li>
<li>
<p>不支持 default 0 </p>
</li>
<li>
<p>00.000000 也支持, 例如：</p>
<p>create table tt ( begin_dt timestamp not null default current timestamp , end_dt timestamp not null default '2000-01-01 00:00:00.000000' )</p>
<p>DB20000I  The SQL command completed successfully.</p>
</li>
</ol>
<p>keyword: db2 create table default value timestamp 0000</p>
<h2 id="db2-db2-sql1477n">db2 查报错方法： <code>db2 ? SQL1477N</code></h2>
<p>sql messages vs  sqlcode vs sqlstate 关系：</p>
<p>通过 <code>db2 ? sql_message</code> 命令，可以查找到 message 对应的 sqlcode 和 sqlstate </p>
<p>sqlcode 是 sql return code .</p>
<p>sqlstate 有特定的编码方式：</p>
<pre><code>ref : https://www-01.ibm.com/support/knowledgecenter/#!/SSEPGG_10.1.0/com.ibm.db2.luw.messages.doc/doc/rdb2stt.html
</code></pre>
<p>如： </p>
<pre><code>01002
</code></pre>
<p>中的 ｀01｀ 是 类别编码，对应一个特定类别。</p>
<p>后3位 <code>002</code> 叫 subcodes ， 是状态本身的编码。</p>
<p>此链接有 3种代码的基本概念介绍：</p>
<pre><code>https://www-01.ibm.com/support/knowledgecenter/#!/ssw_ibm_i_71/rzala/rzalakickoff.htm
</code></pre>
<h3 id="sqlcode">SQLCODE</h3>
<p>An SQLCODE is a return code. The return code is sent by the database manager after completion of each SQL statement.</p>
<p>Each SQLCODE that is recognized by a DB2 for i application server has a corresponding message in the message file QSQLMSG. The message identifier for any SQLCODE is constructed by appending the absolute value (5 digits) of the SQLCODE to SQ and changing the third character to L if the first character of the SQLCODE is 0. For example, if the SQLCODE is 30070, the message identifier is SQ30070. If the SQLCODE is -0204, the message identifier is SQL0204. Lastly, if the SQLCODE is a 3-digit positive number, a zero is added before the first digit. For example, if the SQLCODE is 551, the message identifier is SQL0551.</p>
<h3 id="sqlstate">SQLSTATE</h3>
<p>SQLSTATE provides application programs with common return codes for success, warning, and error conditions that are found among the DB2 products. SQLSTATE values are particularly useful when handling errors in distributed SQL applications. SQLSTATE values are consistent with the SQLSTATE specifications that are contained in the SQL 1999 standard.</p>
<p>An SQLSTATE value is a return code that indicates the outcome of the most recently executed SQL statement. The mechanism used to access SQLSTATE values depends on where the SQL statement is executed. In Java™, SQLSTATE values are returned by using the getSQLState() method. In SQL functions, SQL procedures, SQL triggers, and embedded applications other than Java, SQLSTATE values are returned in the following ways:
The last five bytes of the SQLCA
A stand-alone SQLSTATE variable
The GET DIAGNOSTICS statement
SQLSTATE values are designed so that application programs can test for specific conditions or classes of conditions.</p>
<p>SQLSTATE values are comprised of a two-character class code value, followed by a three-character subclass code value. Class code values represent classes of successful and unsuccessful completion conditions. If you want to use SQLSTATE as the basis of your application's return codes, you can define your own SQLSTATE classes or subclasses using the following guidelines:</p>
<p>SQLSTATE classes that begin with the characters 7 through 9 or I through Z can be defined. Within these classes, any subclass can be defined.
SQLSTATE classes that begin with the characters 0 through 6 or A through H are reserved for the database manager. Within these classes, subclasses that begin with the characters 0 through H are reserved for the database manager. Subclasses that begin with the characters I through Z can be defined.
The class code of an SQLSTATE value indicates whether the SQL statement was executed successfully (class codes 00 and 01) or unsuccessfully (all other class codes).</p>
<p>SQLSTATE is related to SQLCODE. Every SQLSTATE has one or more SQLCODEs associated with it. An SQLSTATE can refer to more than one SQLCODE.</p>
<h4 id="_6">注意</h4>
<ol>
<li>
<p>SQLSTATE is related to SQLCODE. Every SQLSTATE has one or more SQLCODEs associated with it. An SQLSTATE can refer to more than one SQLCODE.</p>
<p>sqlstate 1个 可对应 多个 sqlcodes . 也就是说，多个sqlcodes 可能共用一个 sqlstate . </p>
</li>
<li>
<p>每一个sqlstate的解释：</p>
<p>http://www-01.ibm.com/support/knowledgecenter/?lang=en#!/SSEPGG_9.5.0/com.ibm.db2.luw.messages.doc/doc/rdb2stt.html</p>
</li>
</ol>
<h3 id="sql-message-concepts">SQL message concepts</h3>
<p>SQL messages are displayed when DB2® for i returns an error or warning code to the application that uses it.</p>
<p>To find a specific message, SQLCODE, or SQLSTATE, try the SQL message finder.</p>
<h2 id="sql-message-finder">SQL message finder</h2>
<h2 id="db2-message-code">db2 message code 前缀的含义</h2>
<p>The suffix of a message identifier indicates the severity of the problem:
I - "Information"
W - "Warning"
E - "Error"
N - "Non-critical error"
C - "Critical error"</p>
<p>There is more information in the following topic titled "Introduction to messages":
http://www-01.ibm.com/support/knowledgecenter/api/content/SSEPGG_9.7.0/com.ibm.db2.luw.messages.doc/doc/c0052007.html</p>
<p>所有messages 大集合：</p>
<pre><code>http://www-01.ibm.com/support/knowledgecenter/#!/SSEPGG_9.7.0/com.ibm.db2.luw.messages.sql.doc/doc/rsqlmsg.html?cp=SSEPGG_9.7.0%2F2-6-27
</code></pre>
<h2 id="db2_2">db2 修改日志文件大小和数量</h2>
<p>2015-12-18 09:26 </p>
<p>针对： sqlcode -964, sqlstate 57011 </p>
<p>db2 get db cfg for sample</p>
<p>db2 update db cfg for sample using LOGFILSIZ 4096
 db2 update db cfg for sample using LOGPRIMARY 25</p>
<p>user@localhost:~/Git/gitblog_imx3/output/content$ db2 update db cfg for sample using LOGFILSIZ 4096
 DB20000I  The UPDATE DATABASE CONFIGURATION command completed successfully.
 SQL1363W  Database must be deactivated and reactivated before the changes to 
 one or more of the configuration parameters will be effective.
 user@localhost:~/Git/gitblog_imx3/output/content$ 
 user@localhost:~/Git/gitblog_imx3/output/content$ db2 update db cfg for sample using LOGPRIMARY 25
 DB20000I  The UPDATE DATABASE CONFIGURATION command completed successfully.
 SQL1363W  Database must be deactivated and reactivated before the changes to 
 one or more of the configuration parameters will be effective.</p>
<p>ref: https://www-01.ibm.com/support/knowledgecenter/#!/SSEPGG_10.1.0/com.ibm.db2.luw.messages.sql.doc/doc/msql01363w.html</p>
<p>根据官方解释：</p>
<ol>
<li>
<p>不一定要重新激活。</p>
</li>
<li>
<p>如果要激活，就用deactivate / ACITVATE 命令重新激活。</p>
</li>
<li>
<p>重新激活时，最好远程到服务器上进行。并且fore掉／kill掉所有活动会话。</p>
</li>
</ol>
<p>[db2inst1@localhost ~]$ db2 DEACTIVATE DATABASE sample 
 SQL1495W  Deactivate database is successful, however, there is still a 
 connection to the database.
 [db2inst1@localhost ~]$ ps -ef|grep -i db2
 root       924 32365  0 09:05 pts/0    00:00:00 su - db2inst1
 db2inst1   925   924  0 09:05 pts/0    00:00:00 -bash
 db2inst1  1103     1  0 09:08 pts/0    00:00:00 /home/db2inst1/sqllib/bin/db2bp 925A501 5 A
 db2inst1  1191   925  0 09:10 pts/0    00:00:00 ps -ef
 db2inst1  1192   925  0 09:10 pts/0    00:00:00 grep -i db2
 db2fenc1  1879 32011  0 Dec16 ?        00:00:00 db2fmp ( ,0,0,0,0,0,0,2,1,0,8a65b0,14,1e014,2,0,1,131fc0,0x210000000,0x210000000,1600000,93000c,2,31088023
 db2fenc1  2270 32011  0 Dec16 ?        00:00:00 db2fmp ( ,0,0,0,0,0,0,2,1,0,8a65b0,14,1e014,2,0,1,151fc0,0x210000000,0x210000000,1600000,93000c,2,31138047
 db2fenc1  2887 32011  0 Dec16 ?        00:00:00 db2fmp ( ,0,0,0,0,0,0,2,1,0,8a65b0,14,1e014,2,0,1,171fc0,0x210000000,0x210000000,1600000,93000c,2,31250049
 db2fenc1  3252 32011  0 Dec16 ?        00:00:01 db2fmp ( ,0,0,0,0,0,0,2,1,0,8a65b0,14,1e014,2,0,1,191fc0,0x210000000,0x210000000,1600000,93000c,2,312e8050
 db2fenc1  6375 32011  0 Dec11 ?        00:00:00 db2fmp ( ,0,0,0,0,1,0,2,1,0,8a65b0,14,1e014,2,0,1,f1fc0,0x210000000,0x210000000,1600000,93000c,2,209a0039
 db2fenc1  7479 32011  0 Dec11 ?        00:00:01 db2fmp ( ,0,0,0,0,0,0,2,1,0,8a65b0,14,1e014,2,0,1,111fc0,0x210000000,0x210000000,1600000,93000c,2,20f20048
 db2fenc1  7650 32011  0 Dec08 ?        00:00:00 db2fmp ( ,0,0,0,0,0,0,2,1,0,8a65b0,14,1e014,2,0,1,b1fc0,0x210000000,0x210000000,1600000,93000c,2,1b9a8029
 db2fenc1 27110 32011  0 Dec03 ?        00:00:00 db2fmp ( ,0,0,0,0,0,0,2,1,0,8a65b0,14,1e014,2,0,1,91fc0,0x210000000,0x210000000,1600000,93000c,2,14cc002a
 root     32011     1  0 Nov17 ?        00:00:00 db2wdog                                       <br/>
 db2inst1 32013 32011  0 Nov17 ?        00:19:06 db2sysc                                      <br/>
 root     32014 32013  0 Nov17 ?        00:00:12 db2ckpwd                                      <br/>
 root     32015 32013  0 Nov17 ?        00:00:12 db2ckpwd                                      <br/>
 root     32016 32013  0 Nov17 ?        00:00:12 db2ckpwd                                      <br/>
 db2inst1 32028 32011  0 Nov17 ?        00:11:36 db2acd   ,0,0,0,1,0,0,2,1,0,8a65b0,14,1e014,2,0,1,11fc0,0x210000000,0x210000000,1600000,93000c,2,430016
 db2fenc1 32221 32011  0 Nov17 ?        00:00:03 db2fmp ( ,1,0,0,0,0,0,2,1,0,8a65b0,14,1e014,2,0,1,31fc0,0x210000000,0x210000000,1600000,93000c,2,54802d
 [db2inst1@localhost ~]$ kill 1103
 [db2inst1@localhost ~]$ kill 1103
 -bash: kill: (1103) - No such process
 [db2inst1@localhost ~]$ db2 DEACTIVATE DATABASE sample 
 SQL1496W  Deactivate database is successful, but the database was not 
 activated.
 [db2inst1@localhost ~]$ db2 activate DATABASE sample 
 DB20000I  The ACTIVATE DATABASE command completed successfully.</p>
<p>已成功重激活。</p>
<p>注意，force会话的步骤，是异步的。所以最后先让用户主动关闭连接。然后在force自动连接。</p>
<p>[db2inst1@localhost ~]$ DB2 FORCE APPLICATION ALL
 -bash: DB2: command not found
 [db2inst1@localhost ~]$ db2 force application all
 DB20000I  The FORCE APPLICATION command completed successfully.
 DB21024I  This command is asynchronous and may not be effective immediately.</p>
<h1 id="distinct-clob-dbclob-blob-long-varchar-or-long-vargraphic">不能distinct 的几种数据类型：  CLOB, DBCLOB, BLOB, LONG VARCHAR, or LONG VARGRAPHIC</h1>
<p>user@localhost:~$ db2 "create table testlong( lv long varchar ) "</p>
<p>DB20000I  The SQL command completed successfully.</p>
<p>user@localhost:~$ db2 "select distinct lv from testlong"</p>
<p>SQL0134N  Improper use of a string column, host variable, constant, or 
function "LV".  SQLSTATE=42907</p>
<p>user@localhost:~$ db2 ? SQL0134N</p>
<pre><code>SQL0134N  Improper use of a string column, host variable, constant, or
  function "&lt;name&gt;".

  Explanation:

  The use of the string "&lt;name&gt;" is not permitted.

  An expression resulting in a CLOB, DBCLOB, BLOB, LONG VARCHAR, or LONG
  VARGRAPHIC data type is not permitted in: 
  *  A SELECT DISTINCT statement
  *  A GROUP BY clause
  *  An ORDER BY clause
  *  A column function with DISTINCT
  *  A SELECT or VALUES statement of a set operator other than UNION ALL.

  Federated system users: in a pass-through session, a data
  source-specific restriction can cause this error. See the SQL Reference
  documentation for the failing data sources.

  The statement cannot be processed.

  User response:

  The requested operation on the string is not supported.

   sqlcode: -134

    sqlstate: 42907
</code></pre>
<p>同事问我是不是long varchar 有什么限制，比如不能distinct group by ， 我测试了一下，发现不但long varchar  , 还有  CLOB, DBCLOB, BLOB, LONG VARCHAR, or LONG
583       VARGRAPHIC 等都不能 做 DISTINCT ， GROUP BY ， ORDER BY，set operator 。 </p>
<p>看来还是 勤动手，才能有更多收获！</p>
<h1 id="db2-ese_1">db2 ese 安装</h1>
<h2 id="linux">获取linux发行版本</h2>
<p>cat /etc/*-release</p>
<p>CentOS release 6.5 (Final)
LSB_VERSION=base-4.0-amd64:base-4.0-noarch:core-4.0-amd64:core-4.0-noarch
CentOS release 6.5 (Final)
CentOS release 6.5 (Final)</p>
<h1 id="mysql">MYSQL</h1>
<h2 id="mysql-1040-too-many-connections">mysql : 1040 too many connections  的解决</h2>
<ol>
<li>修改 /etc/my.cnf ( 因系统安装环境而异 )</li>
<li>添加一行参数，例如1000：max_connections = 1000   </li>
<li>切换到 mysql 运维账户，我这里就是 su - mysql</li>
<li>重启： nohup mysqld 2&gt;&amp;1  &gt; mysql.out &amp;</li>
</ol>
<p>另外，
1. 有一个类似的参数，max_user_connections ， 网上说似乎无效，未验证。
2. 使用 show processlist 查看当前连接数。
3. 使用 show variables like "max_connections"  查看参数值。</p>
<h2 id="mysql-full-outer-join">MYSQL 不支持 full outer join</h2>
<p>解决办法：</p>
<pre><code>SELECT * FROM t1
LEFT JOIN t2 ON t1.id = t2.id
UNION
SELECT * FROM t1
RIGHT JOIN t2 ON t1.id = t2.id
</code></pre>
<h2 id="mysql-except-or-minus">MYSQL 不支持 except or minus</h2>
<h2 id="mysql-a">mysql -A 参数</h2>
<p>如果想快点进入mysql交互界面，就使用这个参数。否则，表多的时候，就要等好长时间。</p>
<pre><code>mysql -umeta -pxxxx metadata -h120.xx.xx.xx
</code></pre>
<p>Reading table information for completion of table and column names You can turn off this feature to get a quicker startup with -A</p>
<p>No automatic rehashing. One has to use 'rehash' to get table and field completion. This gives a quicker start of mysql and disables rehashing on reconnect.</p>
<h2 id="mysql-limit">mysql limit 的用法：</h2>
<pre><code>mysql&gt; SELECT * FROM table LIMIT 5,10; // 检索记录行 6-15
</code></pre>
<p>limit m,n 解释:</p>
<p>m(5) -- 表示偏移量。也就是要skip掉m行。</p>
<p>n(10) --  表示从第m行之后，最大可以提取n行。</p>
<h2 id="_7">关联技巧:恢复空表</h2>
<pre><code>INSERT INTO ${PDM_SCH}.LI_COL
SELECT B.*
FROM ${PDM_SCH}.LI_COL_BAK B,
(
    SELECT COUNT(1) AS CNT
        FROM ${PDM_SCH}.LI_COL LIMIT 0,1
        ) O
        WHERE O.CNT=0;
</code></pre>
<h2 id="mysqld">启动mysqld 的时候，一般加什么参数？</h2>
<pre><code>ps -ef|grep -i mysql

结果：

   74    96     1   0 10:57AM ??         0:03.49 /usr/local/mysql/bin/mysqld --user=_mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data --plugin-dir=/usr/local/mysql/lib/plugin --log-error=/usr/local/mysql/data/mysqld.local.err --pid-file=/usr/local/mysql/data/mysqld.local.pid
</code></pre>
<h2 id="mysql_1">mysql 远程连接</h2>
<pre><code>mysql -u -p -hxxx.xxx.xxx.xxx
</code></pre>
<p>可以添加 -A 参数， 让连接响应速度快一点</p>
<h2 id="except-minus-mysql">如果不能用 except , minus , mysql 如何比较两张表？</h2>
<h2 id="mysql-row">mysql 使用 row() 实现 多列比较</h2>
<p>在where 条件中，使用row() 函数，来枚举多列。</p>
<pre><code>mysql&gt; select host , user from user where row(host,user) not in (select '127.0.0.1' host , 'root' user from user );
</code></pre>
<h2 id="mysql-intersect">mysql 模拟 intersect  求差集</h2>
<p>由于mysql 不支持 intersect , 如果要求两个结果集的差集，就需要另辟蹊径.</p>
<p>方法1： 使用 union <em>all</em>  和 group by , having count(0) = 1 求出group by 之后，只有一条的记录。</p>
<pre><code>SELECT MIN (tbl_name) AS tbl_name, PK, column_list -- min / max make no difference 
FROM
 (
  SELECT ' source_table ' as tbl_name, S.PK, S.column_list
  FROM source_table AS S
  UNION ALL
  SELECT 'destination_table' as tbl_name, D.PK, D.column_list
  FROM destination_table AS D 
)  AS alias_table
GROUP BY PK, column_list
HAVING COUNT (0) = 1
ORDER BY PK
</code></pre>
<p>方法2:  使用 row() .. not in (select colList from table )  。 使用 not in 求字段差集。row() ， 在多字段的情况下使用。</p>
<pre><code>SELECT MIN (tbl_name) AS tbl_name, PK, column_list
FROM
 (
  SELECT ' source_table ' as tbl_name, S.PK, S.column_list
  FROM source_table AS S
  UNION ALL
  SELECT 'destination_table' as tbl_name, D.PK, D.column_list
  FROM destination_table AS D 
)  AS alias_table
GROUP BY PK, column_list
HAVING COUNT (*) = 1
ORDER BY PK
</code></pre>
<h2 id="_8">远程数据库连接配置</h2>
<ol>
<li>db2 </li>
</ol>
<p>我的工作电脑是macbook，如果要连接远程的db2，需要在本地做catalog . ibm官方网站上有 v10.1 的db2exc可以下载。可以用来做客户端或者一个简单的开发环境。mac os x 安装db2exc 要用root用户安装，安装之前要设置sysctl.conf参数，重启。然后最好给db2创建单独的用户db2inst1， 这样sqllib就会自动创建到db2inst1的目录下。使用db2icrt创建实例。使用db2sampl创建sample数据库。如果执行db2start时出现权限问题，就要给sqllib下的adm目录赋权。把原来赋给root的权限，chown到db2inst1 。 
当db2可以正常连接后，使用db2 catalog 归档远程数据库。注意：node 关键字是让你给节点起个名字，这个名字我们自己随便取，而不是服务器的特定值。先 归档 远程服务器节点，再归档数据库。端口用50000 五万。</p>
<ol>
<li>mysql </li>
</ol>
<p>连接远程的mysql，需要装本地mysql client 。 使用-h 参数指定远程服务器。使用-A 参数，降低连接时等待rehash的时间。</p>

<h1 id="oracle">ORACLE</h1>
<h2 id="start-with-connect-by-prior">start with ... connect by prior ...  用法</h2>
<p>表格式：sid|pid|level ; s for son , p for parent</p>
<p>start with pid=[截取的根节点nodeA] connect by prior sid = pid</p>
<p>[截取的根节点] : 当我们需要从哪个节点nodeA开始，就是让 pid 取为该开始节点值nodeA。</p>
<p>从 nodeA 开始， 取 [树的子节点son] 字段 ， 通过 prior 字段，取得son节点的祖先， 让 prior sid = pid ; 即 prior son = father ; 意思是 son的祖先＝father 。 更近一步：</p>
<p>prior sunzi = fuqin</p>
<p>prior fuqin = yeye</p>
<p>这样sunzi - fuqin - yeye 都关联起来了。</p>
<p><a href="http://mengya520.blog.51cto.com/1506880/334621">例子</a> ：</p>
<p>select ID, NAME, SYS_CONNECT_BY_PATH(pid,'/') as pid_path, SYS_CONNECT_BY_PATH(parent_name,'/') as parent_name
from test_parent1
start with pid=1 connect by prior id=pid;</p>
<p>如果 你写成 connect by prior pid = id , 那是不行的。 如果pid 还要取祖先，prior pid 的结果，就是爷爷了。 爷爷 ＝ 孙子 怎么行呢？乱套了！</p>
<h2 id="oracle-python">oracle 和 python 交互</h2>
<p>如何在 python 中 操纵 oracle ?</p>
<p>http://www.oracle.com/technetwork/articles/dsl/python-091105.html</p>
<h2 id="oracle-response">oracle response 文件安装方式是怎么回事？</h2>
<ol>
<li>
<p>response 文件安装 也叫响应文件安装方式。</p>
</li>
<li>
<p>response 文件有特定格式。</p>
</li>
<li>
<p>response 文件设定好之后，就不需要再用图形界面方式，通过鼠标点击和键盘输入进行下一步了。</p>
</li>
</ol>
<h2 id="oracle-dml-escape-ampersand">oracle 在执行 dml的时候 escape &amp; (ampersand)符号？</h2>
<pre><code>set define off

SET ESCAPE ON;
</code></pre>

<h1 id="_9">优秀博客</h1>
<h2 id="httpdb2commercecom">http://db2commerce.com/</h2>
<p>ember crooks :</p>
<p>In 2014, IBM named me as an IBM Gold Consultant.</p>
<h1 id="_10">老牌论坛</h1>
<p>http://www.dbforums.com</p><p class="subheader">Category: <a href="/category/tech.html">Tech</a>

    Tagged: 
    <a href="/tag/db.html">DB </a>
    <a href="/tag/database.html">database </a>
    <a href="/tag/shu-ju-ku.html">数据库 </a>
    <a href="/tag/db2.html">db2 </a>
    <a href="/tag/oracle.html">oracle </a>
    <a href="/tag/mysql.html">mysql </a>
</p>



<p><a href="/play-databases.html#disqus_thread">comments</a></p>            </article>

<div class="pagination-centered">
<h6 class="subheader">Page 1 of 1</h6>

<p>

</p>
</div>



            <!-- /#posts-list -->

    </div>
    <!-- End Main Content -->

    <!-- Sidebar -->
    <aside class="large-3 columns">
        <h5 class="sidebar-title">Site</h5>
        <ul class="side-nav">
            <li><a href="/archives.html">Archives</a>
            <li><a href="/tags.html">Tags</a>
        </ul>

		
        <h5 class="sidebar-title">Categories</h5>
        <ul class="side-nav">
            <li><a href="/category/about.html">About</a></li>
            <li><a href="/category/job.html">Job</a></li>
            <li><a href="/category/life.html">Life</a></li>
            <li><a href="/category/misc.html">misc</a></li>
            <li><a href="/category/tech.html">Tech</a></li>
   
        </ul>

        <h5 class="sidebar-title">Links</h5>
        <ul class="side-nav">
            <li><a href="https://www.linkedin.com">LinkedIn</a></li>
            <li><a href="http://www.slideshare.net">SlideShare</a></li>
            <li><a href="https://www.github.com">Github</a></li>
            <li><a href="http://www.zhihu.com">知乎(ZhiHu)</a></li>
            <li><a href="https://www.quora.com">Quora</a></li>
            <li><a href="#">欢迎交换链接</a></li>
        </ul>
		
        <h5 class="sidebar-title">Social</h5>
        <ul class="side-nav">
            <li><a href="http://weibo.com/poooon">See me on Sina WeiBo</a></li>
            <li><a href="http://github.com/willpoon">See me on GitHub</a></li>
        </ul>

    </aside> <!-- End Sidebar -->

</div> <!-- End Main Content and Sidebar -->


<!-- Footer -->
<footer class="row">
    <div class="large-12 columns">
        <hr />
        <div class="row">
            <div class="large-6 columns">
              <!--                  <p>仗梦天涯&nbsp;&nbsp;&nbsp;&nbsp;倚霞而栖 by Poon</p> -->
            </div>
            </div>
    </div>
</footer>
</body>
</html>